# Section 6. ìŠ¤í”„ë§ DB ì ‘ê·¼ ê¸°ìˆ 

## 1. H2 ë°ì´í„°ë² ì´ìŠ¤

### H2ë€?

- ì£¼ë¡œ ê°œë°œì´ë‚˜ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ì‚¬ìš©í•˜ëŠ” ê°€ë³ê³  í¸ë¦¬í•œ DB
- ì›¹ í™”ë©´ì„ ì œê³µí•¨
- [H2 Database Engine](https://www.h2database.com/html/main.html)

### H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜

ê°•ì˜ ì°¸ê³ í•˜ê¸° ğŸ¥°ğŸ¥°

### H2 ì½˜ì†”ì—ì„œ ë°ì´í„° ë² ì´ìŠ¤ ìƒì„±

í…Œì´ë¸” ìƒì„±

```h2
drop table if exists member CASCADE; // ì²˜ìŒ ìƒì„±ì—ì„œëŠ” í•„ìš” X
create table member
(
    id   bigint generated by default as identity, // javaì—ì„œëŠ” longì´ sqlì—ì„œëŠ”bigint
    name varchar(255),
    primary key (id)
);
```

ë°ì´í„° ì¶”ê°€

```h2
INSERT INTO MEMBER (NAME)
VALUES ('spring')
INSERT INTO MEMBER (NAME)
VALUES ('spring2')
INSERT INTO MEMBER (NAME)
VALUES ('spring2')
```

## 2. ìˆœìˆ˜ JDBC

> ì˜ˆì „ì— ë§ì´ ì“°ë˜ ë°©ì‹ìœ¼ë¡œ, ê³¼ê±°ì—ëŠ” ì´ë ‡ê²Œ í–ˆêµ¬ë‚˜ ì •ë„ë¡œ ë“£ê³  ë„˜ê²¨ë„ ëœë‹¤ê³  í•¨

### í™˜ê²½ ì„¤ì •

- `build.gradle` íŒŒì¼ì— jdbc, h2 ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

```shell
// DBë‘ ë¶™ìœ¼ë ¤ë©´ jdbc ë“œë¼ì´ë²„ ê¼­ í•„ìš”
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
// DBë‘ ë¶™ì„ ë•Œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì œê³µí•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ í•„ìš”
runtimeOnly 'com.h2database:h2'
```

- `resources/application.properties` ì— ê²½ë¡œë¥¼ ì¶”ê°€í•˜ì—¬ ìŠ¤í”„ë§ë¶€íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° <br/>
  â‡’ gradleì„ reloadí•˜ë©´ h2.Driverê°€ ì •ìƒì ìœ¼ë¡œ importë¨

```shell
spring.datasource.url=jdbc:h2:tcp://localhost/~/{ë‚´ DB URL}
spring.datasource.driver-class-name=org.h2.Driver
```

### JDBC ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„

JDBC íšŒì› ë¦¬í¬ì§€í† ë¦¬

```java
public class JdbcMemberRepository implements MemberRepository {
    // DBì— ë¶™ìœ¼ë ¤ë©´ DataSource í•„ìš”, ìŠ¤í”„ë§ìœ¼ë¡œë¶€í„° ì£¼ì…ë°›ì•„ì•¼ í•¨
    private final DataSource dataSource;

    // ìŠ¤í”„ë§í•œí…Œ ì£¼ì… ë°›ëŠ” ë¶€ë¶„
    public JdbcMemberRepository(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Member save(Member member) {
        // ? ìœ„ì¹˜ì— íŒŒë¼ë¯¸í„° ë°”ì¸ë”©í•œ ê°’ì´ ë“¤ì–´ê°
        String sql = "insert into member(name) values(?)";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null; // ê²°ê³¼ë¥¼ ë°›ëŠ” ë¶€ë¶„
        try {
            // DB conntectionì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
            conn = getConnection();
            // insertë¬¸ì— ëŒ€í•´ì„œë§Œ í‚¤ ìë™ ìƒì„±
            pstmt = conn.prepareStatement(sql,
                    Statement.RETURN_GENERATED_KEYS);
            // ê°’ì„ ë„£ëŠ” ë¶€ë¶„
            pstmt.setString(1, member.getName());
            // DBì— ì‹¤ì œ ì¿¼ë¦¬ê°€ ë°˜ì˜ë˜ëŠ” ë¶€ë¶„
            pstmt.executeUpdate();
            // RETURN_GENERATED_KEYSë¡œ ìë™ ìƒì„±ëœ í‚¤ë¥¼ ë°˜í™˜
            rs = pstmt.getGeneratedKeys();
            // ê°’ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° êº¼ë‚´ê³  ì—†ëŠ” ê²½ìš° exception ì²˜ë¦¬
            if (rs.next()) {
                member.setId(rs.getLong(1));
            } else {
                throw new SQLException("id ì¡°íšŒ ì‹¤íŒ¨");
            }
            // returnì„ í•´ì£¼ì§€ ì•Šìœ¼ë©´ connectionë§Œ ì—„ì²­ ìŒ“ì´ê²Œ ë˜ë¯€ë¡œ ë°˜ë“œì‹œ returnì„ í†µí•œ releaseë¥¼ í•´ì¤˜ì•¼í•¨ (ì¥ì•  ë°œìƒ ê°€ëŠ¥ì„±ì´ ìˆìŒ)
            return member;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            // ì‚¬ìš©í•œ ìì›ì— ëŒ€í•´ì„œ close í•´ì•¼í•¨
            close(conn, pstmt, rs);
        }
    }

    @Override
    public Optional<Member> findById(Long id) {
        String sql = "select * from member where id = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setLong(1, id);
            // ì¿¼ë¦¬ë¥¼ í†µí•´ ì¡°íšŒí•œ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
            rs = pstmt.executeQuery();
            // ê°’ì„ ë°˜í™˜í•˜ëŠ” ë¶€ë¶„
            if (rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            } else {
                return Optional.empty();
            }
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    @Override
    public List<Member> findAll() {
        String sql = "select * from member";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            rs = pstmt.executeQuery();
            // ëª¨ë“  ì •ë³´ë¥¼ ì°¾ì•„ì˜¤ë¯€ë¡œ listì— ë„£ìŒ
            List<Member> members = new ArrayList<>();
            while (rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                members.add(member);
            }
            return members;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    @Override
    public Optional<Member> findByName(String name) {
        String sql = "select * from member where name = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, name);
            rs = pstmt.executeQuery();
            if (rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            }
            return Optional.empty();
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    private Connection getConnection() {
        return DataSourceUtils.getConnection(dataSource);
    }

    // close ê³¼ì •ì´ ë³µì¡í•˜êµ¬ë‚˜ ë¼ëŠ” ì •ë„ë¡œë§Œ ì•Œê³  ë„˜ì–´ê°€ë„ ë¨
    private void close(Connection conn, PreparedStatement pstmt, ResultSet rs) {
        try {
            if (rs != null) {
                rs.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (pstmt != null) {
                pstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (conn != null) {
                close(conn);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void close(Connection conn) throws SQLException {
        DataSourceUtils.releaseConnection(conn, dataSource);
    }
}
```

configuration ì„ ìƒì„±í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ SpringConfig íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ìŠ¤í”„ë§ ì„¤ì • ë³€ê²½

```java
// ìë°” ì½”ë“œë¡œ ì§ì ‘ ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡í•˜ê¸°
@Configuration
public class SpringConfig {

    private DataSource dataSource;

    @Autowired
    public SpringConfig(DataSource dataSource){
        this.dataSource = dataSource;
    }

    @Bean
    public MemberService memberService() {
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository() {
//        return new MemoryMemberRepository();
        return new JdbcMemberRepository(dataSource);
    }
}
```

### êµ¬í˜„ í´ë˜ìŠ¤ êµ¬ì¡°
MemberService ëŠ” MemberRepository ë¥¼ ì˜ì¡´í•˜ê³  ìˆëŠ” í˜•íƒœì´ë©°,
MemberRepository ëŠ” êµ¬í˜„ì²´ë¡œ MemoryMemberRepository ì™€ JdbcMemberRepository ë¥¼ ê°€ì§€ê³  ìˆìŒ

![](../00.img/section06-01.png)

ì—°ê²°ì„ memory ì—ì„œ jdbc ë¡œ ë³€ê²½í•˜ì˜€ì„ ë¿ ê·¸ ì™¸ì— ë°”ë€ ê²ƒì€ ì—†ìŒ

![](../00.img/section06-02.png)

ìŠ¤í”„ë§ DI ë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ì¡´ ì½”ë“œë¥¼ ì „í˜€ ì†ëŒ€ì§€ ì•Šê³ , ì„¤ì •ë§Œìœ¼ë¡œ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. (ì—°ê²°ë§Œ ë³€ê²½)

â‡’ ê°œë°©-íì‡„ ì›ì¹™ (OCP, Open-Closed Principle) : í™•ì¥ì—ëŠ” ì—´ë ¤ìˆê³ , ìˆ˜ì •/ë³€ê²½ì—ëŠ” ë‹«í˜€ ìˆìŒ

## 3. ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸

ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ DB ë¥¼ ì—°ê²°í•˜ì—¬ í†µí•© í…ŒìŠ¤íŠ¸ ì§„í–‰

### íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸
```java
@SpringBootTest // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ í…ŒìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì‹¤í–‰
class MemberServiceIntegrationTest {

    // í…ŒìŠ¤íŠ¸ì˜ ê²½ìš° ê°€ì¥ í¸í•œ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê²ƒì´ ë” ì¢‹ìœ¼ë¯€ë¡œ ë°”ë¡œ @Autowired í•˜ëŠ” ê²ƒì´ ë‚˜ìŒ
    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

    @Test
    void íšŒì›ê°€ì…() {
        // given
        Member member = new Member();
        member.setName("spring");
        // when
        Long saveId = memberService.join(member);
        // then
        Member findMember = memberService.findOne(saveId).get();
        assertThat(member.getName()).isEqualTo(findMember.getName());
    }
}
```
í…ŒìŠ¤íŠ¸ê°€ ì •ìƒ ì‘ë™í•˜ë©´ DB ì— member ê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
ê·¸ë ‡ê¸°ì— í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¬ì‹¤í–‰ ì‹œ IllegalStateException ì´ ë°œìƒí•œë‹¤.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” DB ì— ì €ì¥ëœ ë‚´ìš©ì„ ì§€ì›Œì•¼ í•œë‹¤.
ìŠ¤í”„ë§ì—ì„œëŠ” `@Transactional` ì´ë¼ëŠ” ì• ë…¸í…Œì´ì…˜ì„ ì œê³µí•˜ëŠ” ë°,
ì´ëŠ” í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ transaction ì„ ì‹¤í–‰í•˜ê³ , í…ŒìŠ¤íŠ¸ê°€ ëë‚œ í›„ rollback í•¨ìœ¼ë¡œì¨ 
DBì— ë°ì´í„°ê°€ ë°˜ì˜í•˜ì§€ ì•Šê²Œ í•´ì¤€ë‹¤.
```java
@SpringBootTest // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ í…ŒìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì‹¤í–‰
@Transactional // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— ì´ ì• ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë©´, í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ì— íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ í•­ìƒ ë¡¤ë°± => DBì— ë°ì´í„°ê°€ ë‚¨ì§€ ì•Šìœ¼ë¯€ë¡œ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ
class MemberServiceIntegrationTest {

    // í…ŒìŠ¤íŠ¸ì˜ ê²½ìš° ê°€ì¥ í¸í•œ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê²ƒì´ ë” ì¢‹ìœ¼ë¯€ë¡œ ë°”ë¡œ @Autowired í•˜ëŠ” ê²ƒì´ ë‚˜ìŒ
    @Autowired
    MemberService memberService;
    @Autowired MemberRepository memberRepository;

    @Test
    void íšŒì›ê°€ì…() {
        // given
        Member member = new Member();
        member.setName("spring");
        // when
        Long saveId = memberService.join(member);
        // then
        Member findMember = memberService.findOne(saveId).get();
        assertThat(member.getName()).isEqualTo(findMember.getName());
    }

}
```

## 4. ìŠ¤í”„ë§ JDBC Template
ìˆœìˆ˜ JDBC ì™€ ë™ì¼í•œ í™˜ê²½ ì„¤ì •ì„ í•˜ë©´ ë˜ê³ , ìŠ¤í”„ë§ JDBC Template, MyBatis ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” JDBC APIì—ì„œ ë³¸ ë°˜ë³µ ì½”ë“œë¥¼ ëŒ€ë¶€ë¶„ ì œê±°í•´ì¤€ë‹¤.
í•˜ì§€ë§Œ **SQL ì€ ì§ì ‘ ì‘ì„±í•´ì•¼ í•œë‹¤.**
```java
public class JdbcTemplateMemberRepository implements MemberRepository{

    // JdbcTemplateë¥¼ ì‚¬ìš©í•  ë•Œ ê¶Œì¥í•˜ëŠ” ìŠ¤íƒ€ì¼--------------------
    private final JdbcTemplate jdbcTemplate;

    @Autowired // ìƒì„±ìê°€ í•˜ë‚˜ì´ë¯€ë¡œ ìƒëµí•´ë„ ê´œì°®ìŒ
    public JdbcTemplateMemberRepository(DataSource dataSource) {
        this.jdbcTemplate = new JdbcTemplate(dataSource);
    }
    //---------------------------------------------------------

    @Override
    public Member save(Member member) {
        // ì¿¼ë¦¬ë¥¼ ì§¤ í•„ìš”ê°€ ì—†ëŠ” í˜•íƒœ - ì´ë ‡ê²Œ í•˜ëŠ”êµ¬ë‚˜! ë¼ê³ ë§Œ ì•Œê³  ë„˜ì–´ê°€ê¸°
        SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
        jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
        Map<String, Object> parameters = new HashMap<>();
        parameters.put("name", member.getName());
        // í‚¤ë¥¼ ë°›ê³  ê·¸ í‚¤ë¥¼ setIdí•´ì„œ returní•˜ëŠ” í˜•íƒœ
        Number key = jdbcInsert.executeAndReturnKey(new MapSqlParameterSource(parameters));
        member.setId(key.longValue());
        return member;
    }

    // JDBCì™€ ë¹„êµí•˜ë©´ ì½”ë“œê°€ ë‹¨ìˆœí•´ì§„ ê²ƒì„ ì•Œ ìˆ˜ ìˆìŒ
    @Override
    public Optional<Member> findById(Long id) {
        List<Member> result = jdbcTemplate.query("select * from member where id = ?", memberRowMapper(), id);
        return  result.stream().findAny();
    }

    @Override
    public Optional<Member> findByName(String name) {
        List<Member> result = jdbcTemplate.query("select * from member where name = ?", memberRowMapper(), name);
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
        return jdbcTemplate.query("select * from member", memberRowMapper());
    }

    private RowMapper<Member> memberRowMapper() {
        return (rs, rowNum) -> {
            Member member = new Member();
            member.setId(rs.getLong("id"));
            member.setName(rs.getString("name"));
            return member;
        };
        /* ìœ„ì˜ ëŒë‹¤ ì½”ë“œê°€ ì£¼ì„ ì²˜ë¦¬í•œ ì½”ë“œì™€ ê°™ì€ ì˜ë¯¸
        return new RowMapper<Member>(){
            @Override
            public Member mapRow(ResultSet rs, int rowNum) throws SQLException {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return member;
            }
        };
         */
    }
}
```
ì½”ë“œ ì‘ì„±ì„ ì™„ë£Œí•˜ë©´ `Spring Config` ë¥¼ ìˆ˜ì •í•˜ì—¬ JDBC Template ì½”ë“œì™€ ì—°ê²°í•´ì¤€ë‹¤.
```java
@Bean
public MemberRepository memberRepository() {
    return new JdbcTemplateMemberRepository(dataSource);
}
```
ì œëŒ€ë¡œ ì‘ë™ë˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì‹¤í–‰ì‹œì¼œì•¼ í•˜ëŠ”ë°, ì´ì „ì— í†µí•©í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‘ì„±í•œ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ í™œìš©í•˜ì!

(í…ŒìŠ¤íŠ¸ì½”ë“œê°€ ì—†ë‹¤ë©´ ì§ì ‘ íšŒì›ê°€ì…ì„ í•´ë³´ê³  ëª©ë¡ì„ í™•ì¸í•´ì•¼ í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ì¸í•´ ê·¸ ìˆ˜ê³ ê°€ ì¤„ì–´ë“¤ì—ˆë‹¤!)

## 5. JPA

JPA ëŠ” ê¸°ì¡´ì˜ ë°˜ë³µ ì½”ë“œ ë¿ë§Œ ì•„ë‹ˆë¼ ê¸°ë³¸ì ì¸ SQL ë„ ì§ì ‘ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•´ì¤€ë‹¤.
ê·¸ëŸ¬ë¯€ë¡œ SQL ê³¼ ë°ì´í„° ì¤‘ì‹¬ì˜ ì„¤ê³„ì—ì„œ ê°ì²´ ì¤‘ì‹¬ì˜ ì„¤ê³„ë¡œ íŒ¨ëŸ¬ë‹¤ì„ì„ ì „í™˜í•  ìˆ˜ ìˆìœ¼ë©°
ê°œë°œ ìƒì‚°ì„± ë˜í•œ í¬ê²Œ í–¥ìƒëœë‹¤.

JPAë¥¼ ì“°ê¸° ìœ„í•´ ë¨¼ì € build.gralde ì„ ìˆ˜ì •í•˜ì! ìˆ˜ì • í›„ reload í•´ì•¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ìš´ ë°›ëŠ”ë‹¤.
`spring-boot-starter-data-jpa` ëŠ” ë‚´ë¶€ì— JDBC ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í¬í•¨í•œë‹¤.
```java
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
```
ê·¸ í›„ application.properties ì— JPA ê´€ë ¨ ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.
```shell
# JPAê°€ ìƒì„±í•˜ëŠ” sqlì„ ë³¼ ìˆ˜ ìˆìŒ
spring.jpa.show-sql=true
# JPAë¥¼ ì‚¬ìš©í•˜ë©´ ê°ì²´ë¥¼ ë³´ê³  ìë™ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ”ë°,
# ì—¬ê¸°ì„œëŠ” ì´ë¯¸ ìƒì„±ëœ í…Œì´ë¸”ì„ ì‚¬ìš©í•  ì˜ˆì •ì´ë¯€ë¡œ í…Œì´ë¸” ìë™ ìƒì„± ê¸°ëŠ¥ì„ ëˆë‹¤.
# noneì´ ì•„ë‹Œ createë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹° ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í…Œì´ë¸”ë„ ì§ì ‘ ìƒì„±í•´ì¤€ë‹¤.
# ìš´ì˜ í™˜ê²½ ê°œë°œì¼ ë•ŒëŠ” í…Œì´ë¸”ì— ìë™ ìƒì„±ë˜ë©´ ì•ˆë˜ë‹ˆ none ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
spring.jpa.hibernate.ddl-auto=none
```
JPA ëŠ” í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ë§Œ ì œê³µí•˜ê³  êµ¬í˜„ì²´ë¡œ hibernate, eclipselink ë“± ì—¬ëŸ¬ ê°œì˜ êµ¬í˜„ ë²¤ë”ë“¤ì´ ìˆë‹¤.
ì—¬ê¸°ì„œëŠ” hibernate ë¥¼ ì‚¬ìš©í•˜ë©°, Mapping ì€ ì• ë…¸í…Œì´ì…˜ì„ ì´ìš©í•œë‹¤.
JPA ì‚¬ìš© ì „, JPA ê°€ ì‚¬ìš©í•˜ëŠ” Entity ë¥¼ ì•Œë ¤ì£¼ê³  PK ë¥¼ ì„¤ì •í•´ì•¼ í•˜ë¯€ë¡œ Member ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•œë‹¤.

```java
@Entity // Entity í‘œì‹œ
public class Member {

    // PK ì„¤ì •, DBê°€ ì•Œì•„ì„œ ìƒì„±í•´ì£¼ëŠ” ê²ƒì„ IDENTITY ë¼ê³  í•¨
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id; // ì‹œìŠ¤í…œì´ ì €ì¥í•˜ëŠ” ID

    // DBì— ì„¤ì •ëœ nameì´ usernameì¸ ê²½ìš° @Column ì• ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ ë§¤í•‘ì‹œí‚¤ë©´ ë¨
    // @Column(name = "username")
    private String name; // íšŒì› ì´ë¦„

    // ë‹¨ìˆœí•˜ê²Œ ì‰¬ìš´ ì˜ˆì œë¡œ í•˜ê¸° ìœ„í•´ getter, setter ì‚¬ìš©
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
```
JPA ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ `EntityManager` ë¥¼ ì£¼ì…í•´ì•¼ í•œë‹¤. JPA ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì •í•œ MemberRepository ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
```java
public class JpaMemberRepository implements MemberRepository{

    // JPAë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ EntityManagerë¥¼ ì£¼ì…ë°›ì•„ì•¼í•¨! (ì´ë ‡ê²Œ ì™¸ì›Œë‘ì„¸ìš” :D)
    private final EntityManager em;

    public JpaMemberRepository(EntityManager em) {
        this.em = em;
    }

    @Override
    public Member save(Member member) {
        // ì´ë ‡ê²Œ í•˜ë©´ JPAê°€ insertí•´ì„œ idê¹Œì§€ ë‹¤ ë„£ì–´ì¤Œ
        em.persist(member);
        return member;
    }

    @Override
    public Optional<Member> findById(Long id) {
        // findì— ì¡°íšŒí•  íƒ€ì…ê³¼ ì‹ë³„ì(PKê°’)ë¥¼ ë„£ì–´ì£¼ë©´ ë¨
        Member member = em.find(Member.class, id);
        return Optional.ofNullable(member);
    }

    @Override
    public Optional<Member> findByName(String name) {
        List<Member> result = em.createQuery("select m from Member m where m.name = :name", Member.class)
                .setParameter("name", name)
                .getResultList();
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
        // jpqa ì¿¼ë¦¬ì˜ ê²½ìš° ê°ì²´(entity)ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¼
        return em.createQuery("select m from Member m", Member.class)
                .getResultList();
    }
}
```
ì´ë ‡ê²Œ ìˆ˜ì •í•œ ì½”ë“œì™€ ì„œë¹„ìŠ¤ë¥¼ ì—°ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” MemberService ì½”ë“œì— @Transactional ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.
JPA ëŠ” ëª¨ë“  ë°ì´í„° ë³€ê²½ì´ Transaction ì•ˆì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
```java
@Transactional
public class MemberService {
    // ...
}
```
ì½”ë“œ ì‹¤í–‰ì„ ìœ„í•´ `SpringConfig` ë¥¼ ìˆ˜ì •í•´ì•¼ í•˜ëŠ”ë°, ì—¬ê¸°ì„œë„ `EntityManager` ë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤
```java
@Configuration
public class SpringConfig {

    private EntityManager em;

    @Autowired
    public SpringConfig(EntityManager em) {
        this.em = em;
    }

    @Bean
    public MemberService memberService() {
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository() {
        return new JpaMemberRepository(em);
    }
}
```
ë™ì‘ì€ ì´ì „ê³¼ ê°™ì´ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í™•ì¸í•œë‹¤.
ë§Œì•½, DBì— ì˜ ë°˜ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì½”ë“œì— @Commit ì• ë…¸í…Œì´ì…˜ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.
```java
@Test
@Commit
void íšŒì›ê°€ì…() {
    // given
    Member member = new Member();
    member.setName("spring");
    // when
    Long saveId = memberService.join(member);
    // then
    Member findMember = memberService.findOne(saveId).get();
    assertThat(member.getName()).isEqualTo(findMember.getName());
}
```

## 6. ìŠ¤í”„ë§ ë°ì´í„° JPA
ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ JPA ë§Œ ì‚¬ìš©í•´ë„ ê°œë°œ ìƒì‚°ì„±ì´ ì •ë§ ë§ì´ ì¦ê°€í•˜ê³ , ê°œë°œí•´ì•¼ í•  ì½”ë“œë„ í™•ì—°íˆ ì¤„ì–´ë“ ë‹¤.
ì—¬ê¸°ì— ìŠ¤í”„ë§ ë°ì´í„° JPA ë¥¼ ì‚¬ìš©í•˜ë©´, ê¸°ì¡´ì˜ í•œê³„ë¥¼ ë„˜ì–´ ë§ˆì¹˜ ë§ˆë²•ì²˜ëŸ¼ ë¦¬í¬ì§€í† ë¦¬ì— êµ¬í˜„ í´ë˜ìŠ¤ ì—†ì´ ì¸í„°í˜ì´ìŠ¤ë§Œìœ¼ë¡œ ê°œë°œì„ ì™„ë£Œí•  ìˆ˜ ìˆë‹¤.
ê·¸ë¦¬ê³  **ë°˜ë³µ ê°œë°œí•´ ì˜¨ ê¸°ë³¸ CRUD ê¸°ëŠ¥ë„ ìŠ¤í”„ë§ ë°ì´í„° JPA ê°€ ëª¨ë‘ ì œê³µ**í•œë‹¤.
ê·¸ë¡œ ì¸í•´ ê°œë°œìëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°œë°œì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

### ìŠ¤í”„ë§ ë°ì´í„° JPA êµ¬í˜„
ìŠ¤í”„ë§ ë°ì´í„° JPA íšŒì› ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¨¼ì € ìƒì„±í•´ë³´ì.
ì¸í„°í˜ì´ìŠ¤ê°€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì† ë°›ì„ ë•ŒëŠ” extends ë¥¼ ì‚¬ìš©í•˜ë©°, ì¸í„°í˜ì´ìŠ¤ëŠ” ë‹¤ì¤‘ ìƒì†ì´ ê°€ëŠ¥í•˜ë‹¤.

```java
public interface SpringDataJpaMemberRepository extends JpaRepository<Member, Long>, MemberRepository {
    @Override
    Optional<Member> findByName(String name);
}
```

ì´ë ‡ê²Œ ì‘ì„±í•˜ë©´ ë!!!

ìŠ¤í”„ë§ ë°ì´í„° JPA ê°€ JPA ë¦¬í¬ì§€í† ë¦¬ë¥¼ ìƒì† ë°›ìœ¼ë©° êµ¬í˜„ì²´ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ë©° ìŠ¤í”„ë§ ë¹ˆì— ìë™ìœ¼ë¡œ ë“±ë¡í•´ì¤€ë‹¤.
ì§ì ‘ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡í•  í•„ìš” ì—†ì´ ê·¸ëƒ¥ ìŠ¤í”„ë§ ë°ì´í„° JPA ê°€ ìƒì„±í•´ ì¤€ ë¹ˆì„ ê°€ì ¸ë‹¤ ì“°ë©´ ëœë‹¤.

SpringConfig ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ memberRepository ë¥¼ ë°›ì•„ì˜¤ëŠ” í˜•íƒœë¡œ ìˆ˜ì •í•œë‹¤.

```java
@Configuration
public class SpringConfig {

    private final MemberRepository memberRepository;

    @Autowired
    public SpringConfig(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }


    @Bean
    public MemberService memberService() {
        return new MemberService(memberRepository);
    }

}
```
í•´ë‹¹ ì½”ë“œë„ ì´ì „ì— ì‘ì„±í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì •ìƒ ë™ì‘í•œë‹¤!

### ìŠ¤í”„ë§ ë°ì´í„° JPA ì œê³µ í´ë˜ìŠ¤

ìŠ¤í”„ë§ ë°ì´í„° JPA ê°€ ìƒì† ë°›ì€ JPA ë¦¬í¬ì§€í† ë¦¬ë¥¼ í™•ì¸í•´ë³´ë©´ ê¸°ë³¸ ë©”ì„œë“œì— ëŒ€í•´ ì œê³µì„ í•´ì£¼ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![](../00.img/section06-03.png)

ìŠ¤í”„ë§ ë°ì´í„° JPA ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
- ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•œ ê¸°ë³¸ì ì¸ CRUD
- `findByName()`, `findByEmail()`ì²˜ëŸ¼ ë©”ì„œë“œ ì´ë¦„ë§Œìœ¼ë¡œ ì¡°íšŒ ê¸°ëŠ¥ ì œê³µ
- í˜ì´ì§• ê¸°ëŠ¥ ìë™ ì œê³µ

ìŠ¤í”„ë§ ë°ì´í„° JPA ê°€ ì œê³µí•˜ëŠ” ë‘ ë²ˆì§¸ ê¸°ëŠ¥ì— ëŒ€í•´ì„œ ì˜ë¬¸ì´ ë“¤ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ìì„¸íˆ ì„¤ëª…í•˜ìë©´,

```java
@Override
Optional<Member> findByName(String name);
```

ìœ„ì™€ ê°™ì€ í˜•íƒœë¡œ ì½”ë“œë¥¼ ì‘ì„±í•œ ê²½ìš° ìŠ¤í”„ë§ ë°ì´í„° JPA ì—ì„œ ì•„ë˜ì™€ ê°™ì€ í˜•íƒœë¡œ JPQL ì„ ì§ ë‹¤.

```sql
select m from Member m where m.name = ?
```

ì´ë ‡ê²Œ ìŠ¤í”„ë§ ë°ì´í„° JPA ë¥¼ í™œìš©í•˜ë©´ ì¸í„°í˜ì´ìŠ¤ ë§Œìœ¼ë¡œ ê°„ë‹¨í•œ ë¶€ë¶„ì— ëŒ€í•´ì„œ ë‹¤ ë§Œë“¤ ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤.
ê·¸ë¦¬ê³  JPA ë§Œìœ¼ë¡œëŠ” ë³µì¡í•œ ë™ì  ì¿¼ë¦¬ êµ¬í˜„ì´ ì–´ë µì§€ë§Œ, Querydsl ì´ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
ì´ ì¡°í•©ìœ¼ë¡œë„ í•´ê²°í•˜ê¸° ì–´ë ¤ìš´ ì¿¼ë¦¬ëŠ” JPA ê°€ ì œê³µí•˜ëŠ” ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, JdbcTemplate ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
ê·¸ë¦¬ê³  JPA ì™€ MyBatis ë¥¼ ì„ì–´ ì“¸ ìˆ˜ë„ ìˆë‹¤.